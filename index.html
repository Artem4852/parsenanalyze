<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Prices Explorer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        :root {
            /* Neutral theme */
            --bg: #0f1316;
            /* neutral dark */
            --panel: #151b20;
            /* card */
            --muted: #1b242b;
            /* inputs */
            --text: #e8edf2;
            --sub: #b3bdc7;
            --accent: #2aa36b;
            /* softer green */
            --ok: #2aa36b;
            --bad: #ef4444;
            --warn: #eab308;
            --border: #27323b;
            --shadow: 0 10px 30px rgba(0, 0, 0, .35);
            --radius: 16px;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans"
        }

        header {
            padding: 18px 22px;
            background: linear-gradient(180deg, #161c22 0%, #0f1316 100%);
            border-bottom: 1px solid var(--border)
        }

        header h1 {
            margin: 0;
            font-size: 18px;
            letter-spacing: .3px
        }

        .wrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: 18px 22px 40px
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin: 12px 0 18px
        }

        .tab {
            background: var(--panel);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 10px 14px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600
        }

        .tab.active {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(42, 163, 107, .25) inset
        }

        section[hidden] {
            display: none !important
        }

        .panel {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow)
        }

        .controls {
            display: grid;
            gap: 14px;
            grid-template-columns: repeat(12, 1fr);
            padding: 16px
        }

        .controls .field {
            grid-column: span 3;
            display: flex;
            flex-direction: column;
            gap: 6px
        }

        .controls .field.wide {
            grid-column: span 6
        }

        label {
            font-size: 12px;
            color: var(--sub);
            letter-spacing: .3px
        }

        select,
        input[type="date"],
        input[type="search"] {
            background: var(--muted);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 12px;
            outline: none
        }

        .row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap
        }

        .btn {
            background: var(--accent);
            color: #0b120e;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            padding: 10px 14px;
            cursor: pointer
        }

        .btn.secondary {
            background: transparent;
            color: var(--text);
            border: 1px solid var(--border)
        }

        .status {
            color: var(--sub);
            font-size: 12px
        }

        .grid {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(12, 1fr)
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: var(--shadow)
        }

        .card h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: var(--sub)
        }

        .kpis {
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(6, 1fr)
        }

        .kpi {
            background: var(--muted);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 12px;
            min-height: 84px;
            display: flex;
            flex-direction: column;
            justify-content: center
        }

        .kpi .label {
            font-size: 11px;
            color: var(--sub)
        }

        .kpi .value {
            font-size: 18px;
            font-weight: 700;
            margin-top: 6px
        }

        .kpi.good .value {
            color: var(--ok)
        }

        .kpi.bad .value {
            color: var(--bad)
        }

        .kpi.warn .value {
            color: var(--warn)
        }

        .col-12 {
            grid-column: span 12
        }

        .col-6 {
            grid-column: span 6
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px
        }

        .table th,
        .table td {
            border-bottom: 1px solid var(--border);
            padding: 10px 8px;
            text-align: left;
            white-space: nowrap
        }

        .table th {
            color: var(--sub);
            font-weight: 600;
            position: sticky;
            top: 0;
            background: var(--panel)
        }

        .pill {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            border: 1px solid var(--border);
            color: var(--sub)
        }

        .pill.clickable {
            cursor: pointer;
            user-select: none
        }

        .pill.clickable:hover {
            background: rgba(255, 255, 255, .04);
            border-color: #31414d
        }

        .pill.active {
            background: rgba(42, 163, 107, .14);
            border-color: var(--accent);
            color: #cfeadd
        }

        .hint {
            font-size: 12px;
            color: var(--sub);
            margin-top: 6px
        }

        .chartWrap {
            height: clamp(260px, 45vh, 480px);
            position: relative
        }

        canvas {
            width: 100%;
            height: 100%
        }

        .chartFsBtn {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 3;
            background: rgba(0, 0, 0, .35);
            color: #d9efe5;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 6px 10px;
            cursor: pointer;
            backdrop-filter: blur(2px)
        }

        .chartFsBtn:hover {
            background: rgba(255, 255, 255, .08);
            border-color: #31414d
        }

        #chartWrap:fullscreen,
        #chartWrap:-webkit-full-screen {
            width: 100vw;
            height: 100vh
        }

        .chartWrap.pseudoFS {
            position: fixed;
            inset: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            background: var(--bg)
        }

        /* Culture selector */
        .culture-panel {
            padding: 16px;
            border-top: 1px dashed var(--border)
        }

        .culture-grid {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(3, 1fr)
        }

        .culture-col {
            padding-right: 20px;
            border-right: 1px solid var(--border)
        }

        .culture-col:last-child {
            border-right: none;
            padding-right: 0
        }

        .culture-head {
            font-size: 12px;
            font-weight: 700;
            color: var(--sub);
            letter-spacing: .4px;
            text-transform: uppercase;
            margin: 2px 0 8px
        }

        .chk {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0
        }

        .chk input {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 10px;
            background: var(--muted);
            border: 1px solid var(--border);
            display: inline-grid;
            place-content: center;
            cursor: pointer;
            transition: border-color .15s ease, background-color .15s ease
        }

        .chk input::after {
            content: "";
            width: 12px;
            height: 12px;
            border-radius: 6px;
            background: var(--accent);
            transform: scale(0);
            transition: transform .12s ease-out
        }

        .chk input:hover {
            border-color: #31414d
        }

        .chk input:focus-visible {
            outline: 2px solid rgba(42, 163, 107, .35);
            outline-offset: 2px
        }

        .chk input:checked {
            background: var(--muted);
            border-color: var(--accent)
        }

        .chk input:checked::after {
            transform: scale(1)
        }

        .chk label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
            line-height: 1.2
        }

        @media (max-width:980px) {
            .controls .field {
                grid-column: span 6
            }

            .kpis {
                grid-template-columns: repeat(3, 1fr)
            }

            .col-6 {
                grid-column: span 12
            }
        }

        @media (max-width:1000px) {
            .culture-grid {
                grid-template-columns: repeat(2, 1fr)
            }
        }

        @media (max-width:640px) {
            .culture-grid {
                grid-template-columns: 1fr
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>Prices Explorer</h1>
    </header>

    <div class="wrap">
        <nav class="tabs">
            <button class="tab active" data-tab="prices">Prices</button>
        </nav>

        <section id="tab-prices">
            <div class="panel">
                <div class="controls">
                    <div class="field wide">
                        <label>Load data</label>
                        <div class="row">
                            <button id="reloadDefault" class="btn">Fetch kernel.json</button>
                            <input id="fileInput" type="file" accept=".json" />
                            <span id="loadStatus" class="status">Waiting…</span>
                        </div>
                        <div class="hint">Default filename: <code>kernel.json</code>.</div>
                    </div>

                    <div class="field">
                        <label>Start date</label>
                        <input id="startDate" type="date" />
                    </div>

                    <div class="field">
                        <label>End date</label>
                        <input id="endDate" type="date" />
                    </div>

                    <div class="field wide">
                        <label>&nbsp;</label>
                        <div class="row">
                            <button id="apply" class="btn">Apply filters</button>
                            <button id="reset" class="btn secondary">Reset</button>
                            <button id="exportCsv" class="btn secondary">Export filtered CSV</button>
                            <span id="sliceStatus" class="status"></span>
                        </div>
                    </div>

                    <div class="field col-12" style="grid-column:span 12">
                        <label>Locations (multi)</label>
                        <div class="row" id="locationsBar"></div>
                    </div>

                    <div class="field col-12" style="grid-column:span 12">
                        <label>Terms (multi)</label>
                        <div class="row" id="termsBar"></div>
                    </div>
                </div>

                <!-- Cultures -->
                <div class="culture-panel">
                    <div class="row" style="justify-content:space-between;align-items:center">
                        <h3 style="margin:0;color:var(--sub)">Select cultures (multiple)</h3>
                        <div class="row">
                            <button id="selectNone" class="btn secondary">Clear all</button>
                        </div>
                    </div>
                    <div id="cultureGrid" class="culture-grid"></div>
                </div>
            </div>

            <div class="grid" style="margin-top:16px">
                <div class="card col-12 chartCard">
                    <h3>Chart</h3>
                    <div class="row" id="monthsQuick"
                        style="gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px">
                        <span class="label" style="font-weight:600">Months:</span>
                        <div id="monthsQuickBar" class="regionsBar"></div>
                        <div style="margin-left: auto;">
                            <button id="monthsAll" class="btn secondary">Select all</button>
                            <button id="monthsNone" class="btn secondary">Deselect all</button>
                        </div>
                    </div>
                    <div class="chartWrap" id="chartWrap">
                        <button id="fsBtn" class="chartFsBtn" title="Enter fullscreen"
                            aria-label="Enter fullscreen">⤢</button>
                        <canvas id="chart"></canvas>
                    </div>
                </div>

                <div class="card col-12">
                    <h3>Summary</h3>
                    <div class="kpis" id="kpis"></div>
                </div>

                <div class="card col-6">
                    <h3>Top Highs</h3>
                    <div class="pill" id="highsInfo"></div>
                    <div style="overflow:auto; max-height:340px; margin-top:8px">
                        <table class="table" id="highsTable"></table>
                    </div>
                </div>

                <div class="card col-6">
                    <h3>Top Lows</h3>
                    <div class="pill" id="lowsInfo"></div>
                    <div style="overflow:auto; max-height:340px; margin-top:8px">
                        <table class="table" id="lowsTable"></table>
                    </div>
                </div>

                <div class="card col-12">
                    <h3>Filtered rows</h3>
                    <div class="pill" id="rowsInfo"></div>
                    <div style="overflow:auto; max-height:420px; margin-top:8px">
                        <table class="table" id="rowsTable"></table>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        (function () {
            // ---------- Utilities ----------
            const $ = sel => document.querySelector(sel);
            const fmtDate = d => new Intl.DateTimeFormat('uk-UA', { year: 'numeric', month: '2-digit', day: '2-digit' }).format(d);
            const fmtUSD = n => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 2 }).format(n);
            const toISO = d => d.toISOString().slice(0, 10);
            const parseISO = s => new Date(s + "T00:00:00Z");
            const mean = a => a.length ? a.reduce((x, y) => x + y, 0) / a.length : null;
            const median = a => { if (!a.length) return null; const b = [...a].sort((x, y) => x - y); const m = Math.floor(b.length / 2); return b.length % 2 ? b[m] : (b[m - 1] + b[m]) / 2; };
            const stdev = a => { if (a.length < 2) return 0; const m = mean(a); const v = a.reduce((s, x) => s + (x - m) * (x - m), 0) / (a.length - 1); return Math.sqrt(v); };
            const escapeHtml = s => String(s).replace(/[&<>"'`]/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '`': '&#96;' }[c]));
            const monthOrder = { 'January': 1, 'February': 2, 'March': 3, 'April': 4, 'May': 5, 'June': 6, 'July': 7, 'August': 8, 'September': 9, 'October': 10, 'November': 11, 'December': 12 };
            const monthSortKey = s => (monthOrder[s] ?? 99) + ' ' + s;
            const dayDiff = (aISO, bISO) => (parseISO(bISO) - parseISO(aISO)) / 86400000;
            const MAX_GAP_DAYS = 62; // ~2 months
            const DASH = [[], [6, 3], [2, 3], [10, 3, 2, 3], [1, 4], [8, 4, 1, 4]];
            const MONTHS = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const selectedMonths = new Set();        // filtering set; empty = show all
            let LAST_MONTHS_AVAILABLE = [];          // for legend sync

            // ---------- State ----------
            let ROWS = []; // {date,dateStr,month,commodity,family,location,terms,value}
            let DATE_MIN = null, DATE_MAX = null;
            let FAMILY_MAP = new Map();
            let LOCATIONS = [], TERMS = [];
            let selectedCulture = null;
            const selectedLoc = new Set();
            const selectedTerms = new Set();
            let chart = null;

            // Distinct line colors (Tableau/ColorBrewer-like)
            const LINE_COLORS = [
                "#4e79a7", "#f28e2b", "#e15759", "#76b7b2", "#59a14f", "#edc949",
                "#af7aa1", "#ff9da7", "#9c755f", "#bab0ab", "#2f4b7c", "#a05195",
                "#86bc86", "#d37295"
            ];

            // ---------- Elements ----------
            const els = {
                reloadDefault: $('#reloadDefault'), fileInput: $('#fileInput'), loadStatus: $('#loadStatus'),
                startDate: $('#startDate'), endDate: $('#endDate'),
                apply: $('#apply'), reset: $('#reset'), exportCsv: $('#exportCsv'), sliceStatus: $('#sliceStatus'),
                kpis: $('#kpis'),
                highsInfo: $('#highsInfo'), lowsInfo: $('#lowsInfo'),
                highsTable: $('#highsTable'), lowsTable: $('#lowsTable'),
                rowsTable: $('#rowsTable'), rowsInfo: $('#rowsInfo'),
                canvas: $('#chart'), chartWrap: $('#chartWrap'), fsBtn: $('#fsBtn'),
                cultureGrid: $('#cultureGrid'), selectNone: $('#selectNone'),
                locationsBar: $('#locationsBar'), termsBar: $('#termsBar'),
                monthsQuickBar: $('#monthsQuickBar'),
                monthsAll: $('#monthsAll'),
                monthsNone: $('#monthsNone'),
            };

            // =================== Normalization (new format) ===================
            function baseFamily(name) {
                const s = String(name).trim(); const m = s.match(/^[\p{L}]+/u); if (!m) return s;
                const w = m[0]; return w.charAt(0).toLocaleUpperCase('uk') + w.slice(1).toLocaleLowerCase('uk');
            }

            function normalize(obj) {
                const out = [];
                for (const [dateKey, dayObj] of Object.entries(obj || {})) {
                    const date = parseISO(dayObj?.date ?? dateKey);
                    const infoArr = Array.isArray(dayObj?.info) ? dayObj.info : [];
                    for (const inf of infoArr) {
                        const location = inf?.location ?? null;
                        const terms = inf?.terms ?? null;
                        const comm = inf?.commodities || {};
                        for (const [monthName, items] of Object.entries(comm)) {
                            for (const [commodityName, price] of Object.entries(items || {})) {
                                const v = (typeof price === 'number') ? price : null;
                                out.push({
                                    date, dateStr: toISO(date),
                                    month: monthName, commodity: commodityName, family: baseFamily(commodityName),
                                    location, terms, value: v
                                });
                            }
                        }
                    }
                }
                out.sort((a, b) => a.date - b.date);
                return out;
            }

            function buildLookups() {
                FAMILY_MAP = new Map(); const locSet = new Set(), termSet = new Set();
                for (const r of ROWS) {
                    if (!FAMILY_MAP.has(r.family)) FAMILY_MAP.set(r.family, new Set());
                    FAMILY_MAP.get(r.family).add(r.commodity);
                    if (r.location != null) locSet.add(r.location);
                    if (r.terms != null) termSet.add(r.terms);
                }
                LOCATIONS = Array.from(locSet).sort((a, b) => a.localeCompare(b, 'uk'));
                TERMS = Array.from(termSet).sort((a, b) => String(a).localeCompare(String(b), 'uk'));
            }

            function populateSelectors() {
                els.startDate.min = toISO(DATE_MIN); els.startDate.max = toISO(DATE_MAX);
                els.endDate.min = toISO(DATE_MIN); els.endDate.max = toISO(DATE_MAX);
                els.startDate.value = toISO(DATE_MIN); els.endDate.value = toISO(DATE_MAX);
                buildCulturePanel();
                buildLocTermsBars();
            }

            function buildCulturePanel() {
                const families = Array.from(FAMILY_MAP.keys()).sort((a, b) => a.localeCompare(b, 'uk'));
                if (!selectedCulture && families.length) selectedCulture = `agg::${families[0]}`;

                const cols = families.map(fam => {
                    const leaves = Array.from(FAMILY_MAP.get(fam)).sort((a, b) => a.localeCompare(b, 'uk'));
                    const allId = `agg::${fam}`;
                    const itemsHtml =
                        `<div class="chk"><input type="radio" name="cultureChoice" id="${allId}" data-mode="agg" data-family="${escapeHtml(fam)}" ${selectedCulture === allId ? 'checked' : ''}><label for="${allId}">${escapeHtml(fam)} - всі</label></div>` +
                        leaves.map(name => {
                            const id = `leaf::${name}`;
                            return `<div class="chk"><input type="radio" name="cultureChoice" id="${id}" data-mode="leaf" data-family="${escapeHtml(fam)}" data-name="${escapeHtml(name)}" ${selectedCulture === id ? 'checked' : ''}><label for="${id}">${escapeHtml(name)}</label></div>`;
                        }).join('');
                    return `<div class="culture-col"><div class="culture-head">${escapeHtml(fam)}</div>${itemsHtml}</div>`;
                }).join('');

                els.cultureGrid.innerHTML = cols;
                els.cultureGrid.addEventListener('change', onCultureChanged);
            }
            function onCultureChanged(e) {
                const input = e.target.closest('input[type="radio"][name="cultureChoice"]');
                if (!input) return;
                const mode = input.dataset.mode, fam = input.dataset.family, name = input.dataset.name;
                selectedCulture = (mode === 'agg') ? `agg::${fam}` : `leaf::${name}`;
                render();
            }

            function buildLocTermsBars() {
                els.locationsBar.innerHTML = LOCATIONS.map(l => `<span class="pill clickable${selectedLoc.has(l) ? ' active' : ''}" data-loc="${escapeHtml(l)}">${escapeHtml(l)}</span>`).join(' ');
                els.termsBar.innerHTML = TERMS.map(t => `<span class="pill clickable${selectedTerms.has(t) ? ' active' : ''}" data-term="${escapeHtml(t)}">${escapeHtml(t)}</span>`).join(' ');
            }

            // ---------- Data ingest ----------
            async function fetchDefault() {
                try {
                    els.loadStatus.textContent = 'Fetching kernel.json…';
                    const res = await fetch('kernel.json', { cache: 'no-cache' });
                    if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
                    const json = await res.json();
                    onData(json);
                    els.loadStatus.textContent = 'Loaded kernel.json ✔';
                } catch (e) { els.loadStatus.textContent = 'Fetch failed. Load a file manually.'; console.error(e); }
            }
            function onFileChosen(file) {
                const r = new FileReader();
                r.onload = () => { try { onData(JSON.parse(r.result)); els.loadStatus.textContent = `Loaded ${file.name} ✔`; } catch { els.loadStatus.textContent = 'Invalid JSON'; } };
                r.readAsText(file);
            }
            function onData(json) {
                ROWS = normalize(json);
                if (!ROWS.length) { els.loadStatus.textContent = 'No rows'; return; }
                DATE_MIN = ROWS[0].date; DATE_MAX = ROWS[ROWS.length - 1].date;
                buildLookups(); populateSelectors(); render();
            }

            // ---------- Filtering + compute datasets (lines = months) ----------
            function getFilters() {
                return {
                    start: parseISO(els.startDate.value || toISO(DATE_MIN)),
                    end: parseISO(els.endDate.value || toISO(DATE_MAX)),
                    cultures: selectedCulture ? [selectedCulture] : [],
                    locations: new Set(selectedLoc),
                    terms: new Set(selectedTerms)
                };
            }

            function cultureMatch(r, cultures) {
                if (!cultures.length) return true;
                for (const s of cultures) {
                    const [mode, key] = s.split('::');
                    if (mode === 'leaf' && r.commodity === key) return true;
                    if (mode === 'agg' && r.family === key) return true;
                }
                return false;
            }
            function passLoc(r, f) {
                if (f.locations.size > 0) return f.locations.has(r.location) || r.location == null;
                return true;
            }
            function passTerms(r, f) {
                if (f.terms.size > 0) return f.terms.has(r.terms) || r.terms == null;
                return true;
            }
            function groupBy(arr, keyFn) {
                const m = new Map(); for (const x of arr) { const k = keyFn(x); const a = m.get(k); if (a) a.push(x); else m.set(k, [x]); } return m;
            }

            function computeSeries(f) {
                const scope = ROWS.filter(r =>
                    r.date >= f.start && r.date <= f.end &&
                    cultureMatch(r, f.cultures) &&
                    passLoc(r, f) && passTerms(r, f)
                );
                const byDate = groupBy(scope, r => r.dateStr);
                const labels = Array.from(byDate.keys()).sort();

                const monthsInData = new Set(scope.map(r => r.month));
                let months = MONTHS.filter(m => monthsInData.has(m));
                if (selectedMonths.size) months = months.filter(m => selectedMonths.has(m));

                const datasets = [], statsRows = [];
                months.forEach((m, i) => {
                    const data = [];
                    for (const d of labels) {
                        const rows = (byDate.get(d) || []).filter(r => r.month === m);
                        const vals = rows.map(r => r.value).filter(v => v != null);
                        const v = vals.length ? mean(vals) : null;
                        data.push(Number.isFinite(v) ? v : null);
                        if (Number.isFinite(v)) statsRows.push({ date: parseISO(d), dateStr: d, month: m, value: v });
                    }
                    datasets.push({ label: m, color: LINE_COLORS[i % LINE_COLORS.length], main: data });
                });

                return { labels, datasets, statsRows };
            }

            function computeYBounds(datasets) {
                const vals = []; for (const ds of datasets) { ds.main.forEach(v => Number.isFinite(v) && vals.push(v)); }
                if (!vals.length) return {};
                let minV = Math.min(...vals), maxV = Math.max(...vals);
                if (minV === maxV) { const pad = Math.max(1, Math.abs(minV) * 0.05); return { suggestedMin: minV - pad, suggestedMax: maxV + pad }; }
                const span = maxV - minV; const pad = Math.max(1, span * 0.08); return { suggestedMin: minV - pad, suggestedMax: maxV + pad };
            }

            function computeStats(rows) {
                const vals = rows.map(r => r.value).filter(v => v != null); if (!vals.length) return null;
                const minVal = Math.min(...vals), maxVal = Math.max(...vals);
                const avgVal = mean(vals), medVal = median(vals), sdVal = stdev(vals);
                const cov = avgVal ? (sdVal / avgVal) * 100 : 0;
                const minRow = rows.find(r => r.value === minVal), maxRow = rows.find(r => r.value === maxVal);
                return { count: vals.length, minVal, maxVal, avgVal, medVal, sdVal, cov, minRow, maxRow };
            }

            function highsLows(rows, take = 10) {
                const good = rows.filter(r => r.value != null);
                const highs = [...good].sort((a, b) => b.value - a.value).slice(0, take);
                const lows = [...good].sort((a, b) => a.value - b.value).slice(0, take);
                return { highs, lows };
            }

            function renderTable(tableEl, headers, rows) {
                while (tableEl.firstChild) tableEl.removeChild(tableEl.firstChild);
                const thead = document.createElement('thead'); const trh = document.createElement('tr');
                headers.forEach(h => { const th = document.createElement('th'); th.textContent = h; trh.appendChild(th); }); thead.appendChild(trh);
                const tbody = document.createElement('tbody');
                if (!rows.length) { const tr = document.createElement('tr'); const td = document.createElement('td'); td.textContent = '—'; td.colSpan = headers.length; tr.appendChild(td); tbody.appendChild(tr); }
                else { rows.forEach(row => { const tr = document.createElement('tr'); row.forEach(cell => { const td = document.createElement('td'); td.textContent = String(cell); tr.appendChild(td); }); tbody.appendChild(tr); }); }
                tableEl.appendChild(thead); tableEl.appendChild(tbody);
            }

            // ---------- Render ----------
            function render() {
                const f = getFilters();
                const monthsAvail = monthsAvailable(f);
                LAST_MONTHS_AVAILABLE = monthsAvail;
                buildMonthsQuickBar(monthsAvail);        // new quick bar
                const multi = computeSeries(f);

                const maxTicks = Math.max(3, Math.floor((els.chartWrap?.clientWidth || window.innerWidth || 360) / 70));
                const formatTickLabel = (iso, maxTicks) => { const d = new Date(iso + 'T00:00:00Z'); if (maxTicks <= 4) return String(d.getUTCFullYear()); if (maxTicks <= 8) return d.toLocaleDateString('uk-UA', { year: '4-digit', month: '2-digit' }); return d.toLocaleDateString('uk-UA', { year: '2-digit', month: '2-digit', day: '2-digit' }); };

                // Build datasets with dynamic segment coloring to break >2m gaps
                const datasets = multi.datasets.map(ds => ({
                    label: ds.label,
                    data: ds.main,
                    borderWidth: 2.5,
                    borderColor: ds.color,
                    pointRadius: 0,
                    pointHitRadius: 14,      // easier hover
                    pointHoverRadius: 6,
                    pointHoverBorderWidth: 2,
                    tension: .25,
                    spanGaps: false, // allow short spans
                    segment: {
                        borderColor: ctx => {
                            const i0 = ctx.p0DataIndex, i1 = ctx.p1DataIndex;
                            // If either is null, Chart won't call; but in spanGaps:true, it connects across nulls.
                            // We compute actual time gap and hide the segment if > MAX_GAP_DAYS.
                            const a = multi.labels[i0], b = multi.labels[i1];
                            return (dayDiff(a, b) > MAX_GAP_DAYS) ? 'rgba(0,0,0,0)' : ds.color;
                        }
                    }
                }));

                const yb = computeYBounds(multi.datasets);

                if (chart) chart.destroy();
                chart = new Chart(els.canvas.getContext('2d'), {
                    type: 'line',
                    data: { labels: multi.labels, datasets },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            x: { ticks: { color: '#b3bdc7', maxRotation: 0, minRotation: 0, autoSkip: true, autoSkipPadding: 12, maxTicksLimit: maxTicks, callback: (_, idx) => formatTickLabel(multi.labels[idx], maxTicks) }, grid: { color: 'rgba(39,50,59,0.55)' } },
                            y: { ticks: { color: '#b3bdc7', callback: (v) => fmtUSD(v) }, grid: { color: 'rgba(39,50,59,0.55)' }, ...yb }
                        },
                        interaction: { mode: 'index', intersect: false, axis: 'x' }, // hover anywhere along x
                        elements: { point: { hitRadius: 14, hoverRadius: 6 } },       // global safety net
                        plugins: {
                            legend: {
                                labels: { color: '#e8edf2' },
                                onClick: (e, li, legend) => {
                                    const label = li.text;
                                    if (selectedMonths.size === 0) { selectedMonths.clear(); LAST_MONTHS_AVAILABLE.forEach(x => selectedMonths.add(x)); }
                                    selectedMonths.has(label) ? selectedMonths.delete(label) : selectedMonths.add(label);
                                    render();
                                }
                            }, tooltip: { callbacks: { title: (c) => c[0]?.label || '', label: (c) => `${c.dataset.label}: ${fmtUSD(c.parsed.y)}` } }
                        }
                    }
                });

                els.sliceStatus.textContent = `${multi.statsRows.length} observations`;

                const stats = computeStats(multi.statsRows); const items = [];
                items.push(kpi('Observations', String(multi.statsRows.length || 0)));
                if (stats) {
                    items.push(kpi('Min', fmtUSD(stats.minVal), 'bad', `${fmtDate(stats.minRow.date)} • ${stats.minRow.month}`));
                    items.push(kpi('Max', fmtUSD(stats.maxVal), 'good', `${fmtDate(stats.maxRow.date)} • ${stats.maxRow.month}`));
                    items.push(kpi('Mean', fmtUSD(stats.avgVal)));
                    items.push(kpi('Median', fmtUSD(stats.medVal)));
                    items.push(kpi('StDev', fmtUSD(stats.sdVal), 'warn'));
                    items.push(kpi('CoV', `${stats.cov.toFixed(1)}%`));
                }
                els.kpis.innerHTML = items.join('');

                const { highs, lows } = highsLows(multi.statsRows, 10);
                els.highsInfo.textContent = `${highs.length} records`;
                els.lowsInfo.textContent = `${lows.length} records`;
                renderTable(els.highsTable, ['Date', 'Month', 'Price'], highs.map(r => [fmtDate(r.date), r.month, fmtUSD(r.value)]));
                renderTable(els.lowsTable, ['Date', 'Month', 'Price'], lows.map(r => [fmtDate(r.date), r.month, fmtUSD(r.value)]));
                els.rowsInfo.textContent = `${multi.statsRows.length} rows`;
                renderTable(els.rowsTable, ['Date (local)', 'ISO', 'Month', 'Value'], multi.statsRows.map(r => [fmtDate(r.date), r.dateStr, r.month, fmtUSD(r.value)]));
            }

            function kpi(label, value, mood, sub) {
                return `<div class="kpi ${mood || ''}">
        <div class="label">${escapeHtml(label)}</div>
        <div class="value">${escapeHtml(value)}</div>
        ${sub ? `<div class="label" style="margin-top:6px">${escapeHtml(sub)}</div>` : ''}
      </div>`;
            }

            function monthsAvailable(f) {
                const scope = ROWS.filter(r =>
                    r.date >= f.start && r.date <= f.end &&
                    cultureMatch(r, f.cultures) &&
                    passLoc(r, f) && passTerms(r, f)
                );
                const set = new Set(scope.map(r => r.month));
                return MONTHS.filter(m => set.has(m));
            }

            function exportCsv() {
                const f = getFilters(); const { statsRows } = computeSeries(f); if (!statsRows.length) return;
                const rows = [['date_local', 'date_iso', 'month', 'value', 'currency']];
                for (const r of statsRows) { rows.push([fmtDate(r.date), r.dateStr, r.month, r.value, 'USD']); }
                const csv = rows.map(r => r.map(v => { const s = String(v); return /[",\n]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s; }).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = 'filtered_prices.csv'; document.body.appendChild(a); a.click();
                setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 100);
            }

            function buildMonthsQuickBar(months) {
                const isActive = m => (selectedMonths.size === 0) || selectedMonths.has(m);
                els.monthsQuickBar.innerHTML = months.map(m =>
                    `<span class="pill clickable ${isActive(m) ? 'active' : ''}" data-month-q="${m}">${m}</span>`
                ).join(' ');
            }
            els.monthsQuickBar.addEventListener('click', e => {
                const t = e.target.closest('.pill.clickable[data-month-q]'); if (!t) return;
                const m = t.getAttribute('data-month-q');
                if (selectedMonths.size === 0) selectedMonths.clear(), LAST_MONTHS_AVAILABLE.forEach(x => selectedMonths.add(x));
                selectedMonths.has(m) ? selectedMonths.delete(m) : selectedMonths.add(m);
                render();
            });
            els.monthsAll.addEventListener('click', () => { selectedMonths.clear(); render(); });
            els.monthsNone.addEventListener('click', () => { selectedMonths.clear(); selectedMonths.add('__NONE__'); render(); });

            // ---------- Events ----------
            els.reloadDefault.addEventListener('click', fetchDefault);
            els.fileInput.addEventListener('change', e => { const f = e.target.files?.[0]; if (f) onFileChosen(f); });
            els.apply.addEventListener('click', render);
            els.reset.addEventListener('click', () => {
                selectedLoc.clear(); selectedTerms.clear();
                els.startDate.value = toISO(DATE_MIN); els.endDate.value = toISO(DATE_MAX);
                const families = Array.from(FAMILY_MAP.keys()).sort((a, b) => a.localeCompare(b, 'uk'));
                selectedCulture = families.length ? `agg::${families[0]}` : null;
                buildCulturePanel(); buildLocTermsBars(); render();
            });
            els.selectNone.addEventListener('click', () => {
                const families = Array.from(FAMILY_MAP.keys()).sort((a, b) => a.localeCompare(b, 'uk'));
                selectedCulture = families.length ? `agg::${families[0]}` : null;
                buildCulturePanel();
                render();
            });

            els.exportCsv.addEventListener('click', exportCsv);

            els.locationsBar.addEventListener('click', e => {
                const t = e.target.closest('.pill.clickable[data-loc]'); if (!t) return;
                const v = t.getAttribute('data-loc'); selectedLoc.has(v) ? selectedLoc.delete(v) : selectedLoc.add(v);
                buildLocTermsBars(); render();
            });
            els.termsBar.addEventListener('click', e => {
                const t = e.target.closest('.pill.clickable[data-term]'); if (!t) return;
                const v = t.getAttribute('data-term'); selectedTerms.has(v) ? selectedTerms.delete(v) : selectedTerms.add(v);
                buildLocTermsBars(); render();
            });

            // Fullscreen
            function fsElement() { return document.fullscreenElement || document.webkitFullscreenElement || null; }
            function inFullscreen() { return fsElement() === els.chartWrap || els.chartWrap.classList.contains('pseudoFS'); }
            function updateFsButton() { if (inFullscreen()) { els.fsBtn.textContent = '⤡'; els.fsBtn.title = 'Exit fullscreen'; } else { els.fsBtn.textContent = '⤢'; els.fsBtn.title = 'Enter fullscreen'; } }
            async function enterFs() { try { if (els.chartWrap.requestFullscreen) { await els.chartWrap.requestFullscreen({ navigationUI: 'hide' }); } else if (els.chartWrap.webkitRequestFullscreen) { els.chartWrap.webkitRequestFullscreen(); } else { throw new Error('no fs'); } } catch (e) { els.chartWrap.classList.add('pseudoFS'); onFsChange(); } }
            async function exitFs() { try { if (document.exitFullscreen) { await document.exitFullscreen(); } else if (document.webkitExitFullscreen) { document.webkitExitFullscreen(); } else { throw new Error('no exit'); } } catch (e) { els.chartWrap.classList.remove('pseudoFS'); onFsChange(); } }
            function scheduleRerender() { clearTimeout(window.__rt); window.__rt = setTimeout(() => render(), 120); }
            function onFsChange() { updateFsButton(); scheduleRerender(); }
            els.fsBtn.addEventListener('click', () => { inFullscreen() ? exitFs() : enterFs(); });
            document.addEventListener('fullscreenchange', onFsChange);
            document.addEventListener('webkitfullscreenchange', onFsChange);
            window.addEventListener('resize', scheduleRerender);

            // Start
            fetchDefault();
        })();
    </script>
</body>

</html>